<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STMS (Survey-based Travel Management System)</title>

  <!--
    사용 방법:
    1) 이 파일을 index.html 로 저장
    2) 같은 폴더에 stms_db.xlsx 를 둠
    3) python3 -m http.server 8080
    4) http://localhost:8080 접속

    주의:
    - 엑셀(xlsx) 파싱을 위해 SheetJS(xlsx) 라이브러리를 CDN으로 불러옵니다.
      오프라인 환경이면 아래 <script src=...> 를 로컬 파일로 바꿔주세요.
  -->

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg0:#070c14;
      --bg1:#0b1220;
      --panel:#0f1a2d;
      --panel2:#0c1628;
      --line:rgba(255,255,255,.08);
      --text:#e7eefc;
      --muted:rgba(231,238,252,.70);
      --muted2:rgba(231,238,252,.55);

      --blue:#3b82f6;
      --blue2:#1d4ed8;
      --glow:rgba(59,130,246,.18);

      --green:#22c55e;
      --red:#ef4444;
      --amber:#f59e0b;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(59,130,246,.25), transparent 60%),
        radial-gradient(650px 450px at 90% 10%, rgba(29,78,216,.22), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    a{color:inherit}
    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
    }

    /* Topbar */
    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(7,12,20,.92), rgba(7,12,20,.72));
      border-bottom: 1px solid var(--line);
    }
    .topbar-inner{
      max-width: 1180px;
      margin:0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      gap:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 260px;
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.22), transparent 60%),
                  linear-gradient(135deg, var(--blue), var(--blue2));
      box-shadow: 0 10px 30px rgba(59,130,246,.22);
      border:1px solid rgba(255,255,255,.12);
    }
    .brand h1{
      margin:0;
      font-size: 14.5px;
      font-weight: 750;
      letter-spacing: .2px;
      line-height: 1.2;
    }
    .brand .sub{
      margin-top:2px;
      font-size: 12px;
      color:var(--muted2);
    }

    .topbar-right{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(15,26,45,.7);
      border: 1px solid var(--line);
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: var(--blue);
      box-shadow: 0 0 0 6px rgba(59,130,246,.14);
    }
    .steps{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .step{
      cursor:pointer;
      user-select:none;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(15,26,45,.55);
      color: var(--muted);
      font-size: 12px;
      transition: .15s ease;
    }
    .step:hover{border-color: rgba(59,130,246,.35); color: var(--text)}
    .step.active{
      background: linear-gradient(135deg, rgba(59,130,246,.22), rgba(29,78,216,.16));
      border-color: rgba(59,130,246,.45);
      color: var(--text);
      box-shadow: 0 0 0 6px rgba(59,130,246,.10);
    }

    /* Layout */
    .container{
      width:100%;
      max-width: 1180px;
      margin: 0 auto;
      padding: 22px 18px 50px;
      flex:1;
    }

    .page{display:none}
    .page.active{display:block}

    .card{
      background: linear-gradient(180deg, rgba(15,26,45,.78), rgba(12,22,40,.70));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    /* Start page */
    .hero{
      padding: 32px 26px;
      display:flex;
      gap:22px;
      align-items:stretch;
    }
    .hero-left{flex:1}
    .hero-right{
      width: 420px;
      max-width: 100%;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .hero h2{
      margin:0;
      font-size: 28px;
      letter-spacing: .2px;
      line-height: 1.2;
    }
    .hero p{
      margin: 10px 0 0;
      color: var(--muted);
      line-height: 1.6;
      font-size: 14px;
    }
    .hero .meta{
      margin-top: 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(8,14,26,.55);
      color: var(--muted);
      font-size: 12px;
    }
    .btn{
      cursor:pointer;
      border:0;
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 700;
      letter-spacing: .2px;
      color: var(--text);
      background: rgba(15,26,45,.65);
      border:1px solid var(--line);
      transition:.15s ease;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(59,130,246,.35)}
    .btn-primary{
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(29,78,216,.95));
      border-color: rgba(255,255,255,.10);
      box-shadow: 0 20px 50px rgba(59,130,246,.22);
    }
    .btn-primary:hover{filter:brightness(1.04)}
    .btn-ghost{
      background: rgba(15,26,45,.35);
    }
    .small{
      font-size:12px;color:var(--muted2);line-height:1.45
    }

    /* Survey header */
    .survey-head{
      padding: 18px 18px 16px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,26,45,.72), rgba(12,22,40,.60));
      box-shadow: 0 18px 50px rgba(0,0,0,.28);
      margin-bottom: 14px;
    }
    .survey-head-top{
      display:flex;
      align-items:flex-start;
      gap:14px;
      flex-wrap:wrap;
    }
    .survey-head h3{
      margin:0;
      font-size: 20px;
      letter-spacing:.2px;
    }
    .survey-head p{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }
    .survey-actions{
      margin-left:auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .search-row{
      margin-top: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .input{
      flex:1;
      min-width: 260px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(6,10,18,.55);
      color: var(--text);
      outline: none;
      box-shadow: 0 0 0 0 rgba(59,130,246,0);
      transition: .15s ease;
    }
    .input:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 6px rgba(59,130,246,.12);
    }
    .btn-sm{
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 750;
    }

    /* Section */
    .section{
      margin-top: 16px;
    }
    .section-title{
      margin: 14px 2px 10px;
      display:flex;
      align-items:baseline;
      gap:10px;
    }
    .section-title h4{
      margin:0;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .section-title .kdesc{
      color: var(--muted2);
      font-size: 12px;
    }

    /* Scenario card */
    .scenario{
      border: 1px solid var(--line);
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(13,20,34,.75), rgba(10,16,28,.62));
      box-shadow: 0 18px 50px rgba(0,0,0,.28);
      overflow:hidden;
      margin-bottom: 12px;
    }
    .scenario-head{
      padding: 14px 14px 12px;
      display:flex;
      align-items:flex-start;
      gap:12px;
    }
    .scenario-title{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      flex:1;
      min-width: 240px;
    }
    .scenario-name{
      font-weight: 850;
      letter-spacing: .2px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(15,26,45,.65);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .badge strong{color:var(--text)}
    .badge.blue{
      border-color: rgba(59,130,246,.35);
      background: rgba(59,130,246,.12);
      color: rgba(231,238,252,.90);
    }
    .status{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill-status{
      font-weight: 900;
      letter-spacing:.3px;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .pill-status.green{background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.35); color: rgba(231,252,242,.92)}
    .pill-status.red{background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.35); color: rgba(255,235,235,.92)}

    .scenario-sub{
      padding: 0 14px 12px;
      color: var(--muted);
      font-size: 12.5px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .scenario-sub b{color:var(--text)}
    .scenario-body{
      border-top: 1px solid rgba(255,255,255,.06);
      padding: 12px 14px 14px;
    }

    .control{
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 16px;
      background: rgba(6,10,18,.35);
      margin-bottom: 10px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .control:last-child{margin-bottom:0}
    .control-text{
      flex:1;
      min-width: 240px;
      line-height: 1.5;
      font-size: 13px;
      color: rgba(231,238,252,.92);
      white-space: pre-wrap;
    }
    .control-meta{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted2);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .hint{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(255,255,255,.14);
      background: rgba(15,26,45,.35);
      color: var(--muted2);
      font-size: 12px;
      white-space:nowrap;
    }
    .hint.reco{
      border-style: solid;
      border-color: rgba(245,158,11,.35);
      background: rgba(245,158,11,.12);
      color: rgba(255,242,219,.92);
      font-weight: 800;
    }
    .seg{
      display:inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: rgba(15,26,45,.45);
    }
    .seg button{
      cursor:pointer;
      border:0;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 850;
      color: var(--muted);
      background: transparent;
      transition: .12s ease;
      min-width: 54px;
    }
    .seg button:hover{background: rgba(255,255,255,.06); color: var(--text)}
    .seg button.active-yes{
      background: rgba(59,130,246,.22);
      color: var(--text);
    }
    .seg button.active-no{
      background: rgba(255,255,255,.08);
      color: rgba(231,238,252,.90);
    }

    .collapse-row{
      display:flex;
      align-items:center;
      gap:8px;
      margin-left:auto;
      color: var(--muted2);
      font-size: 12px;
    }
    .linklike{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(15,26,45,.40);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      transition:.15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .linklike:hover{border-color: rgba(59,130,246,.35); color: var(--text)}
    .hidden{display:none !important}

    /* Results */
    .results-head{
      padding: 18px 18px 16px;
      margin-bottom: 14px;
    }
    .results-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .result-item{
      padding: 14px 14px;
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 18px;
      background: rgba(6,10,18,.32);
    }
    .result-top{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .result-name{font-weight:850}
    .result-sub{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12.5px;
      line-height:1.55;
    }
    .reco-list{
      margin-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.12);
      padding-top: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .reco-item{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(245,158,11,.22);
      background: rgba(245,158,11,.08);
    }
    .reco-item .txt{flex:1; white-space:pre-wrap; line-height:1.45; font-size: 12.5px; color: rgba(255,245,225,.92)}
    .reco-item .kpi{
      font-size: 12px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,245,225,.95);
      white-space:nowrap;
    }

    /* Overlays */
    .overlay{
      position: fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 22px;
      background: rgba(0,0,0,.55);
      z-index: 999;
    }
    .overlay.show{display:flex}
    .modal{
      width: min(720px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(15,26,45,.92), rgba(10,16,28,.92));
      box-shadow: 0 30px 80px rgba(0,0,0,.60);
      padding: 18px 18px;
    }
    .modal h3{margin:0 0 8px; font-size:16px}
    .modal p{margin:0; color:var(--muted); line-height:1.55; font-size:13px}
    .modal .row{margin-top:12px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap}

    @media (max-width: 960px){
      .hero{flex-direction:column}
      .hero-right{width:100%}
      .brand{min-width:auto}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>STMS (Survey-based Travel Management System)</h1>
          <div class="sub">Okinawa 자유여행 위험관리 survey· DoA = <span id="doaTextTop">4</span></div>
        </div>
      </div>

      <div class="topbar-right">
        <div class="pill" title="Yes로 체크한 통제 수 / 전체 통제 수">
          <span class="dot" aria-hidden="true"></span>
          <span><b id="yesCount">0</b> / <b id="totalControls">0</b></span>
          <span style="color:var(--muted2)">Yes</span>
        </div>
        <div class="steps">
          <div class="step active" data-nav="start">Start</div>
          <div class="step" data-nav="survey">Survey</div>
          <div class="step" data-nav="results">Results</div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Start Page -->
    <section id="page-start" class="page active">
      <div class="card hero">
        <div class="hero-left">
          <h2>STMS Survey</h2>
          <p>
            오키나와 자유여행에서 발생 가능한 위험 시나리오별로, 준비된 통제(Control)를 <b>Yes/No</b>로 체크하세요.
            최종 Risk가 <b>DoA(=4)</b> 이상인 시나리오는 <b style="color:var(--red)">RED</b>로 표시되며,
            적용 시 Risk를 DoA 미만으로 내릴 수 있는 통제를 <b style="color:var(--amber)">Final KPI</b> 기준으로 추천합니다.
          </p>
          <div class="meta">
            <span class="tag">데이터 소스: <b>stms_db.xlsx</b></span>
            <span class="tag">정렬 기준: <b>Final KPI (내림차순)</b></span>
            <span class="tag">판정: <b>Risk &lt; 4 → GREEN</b> / <b>Risk ≥ 4 → RED</b></span>
          </div>
        </div>
        <div class="hero-right">
          <button id="btnStart" class="btn btn-primary">시작</button>
          <button id="btnReload" class="btn btn-ghost">엑셀 다시 읽기</button>
          <div class="small">
            ✔ 같은 폴더에 <b>stms_db.xlsx</b>가 있어야 합니다.<br/>
            ✔ 반드시 <b>http://localhost:8080</b> 처럼 서버로 열어야 fetch가 됩니다.<br/>
            ✔ 엑셀 첫 번째 열(<b>Risk 시나리오</b>)이 비어 있으면 해당 행은 무시합니다.
          </div>
        </div>
      </div>
    </section>

    <!-- Survey Page -->
    <section id="page-survey" class="page">
      <div class="survey-head">
        <div class="survey-head-top">
          <div>
            <h3>설문</h3>
            <p>각 통제 항목에 대해 준비되었으면 <b>Yes</b>, 아니면 <b>No</b>를 선택하세요.</p>
          </div>
          <div class="survey-actions">
            <button id="btnReset" class="btn btn-sm">초기화</button>
            <button id="btnToResults" class="btn btn-primary btn-sm">설문 완료 · 결과 보기</button>
          </div>
        </div>
        <div class="search-row">
          <input id="searchBox" class="input" placeholder="시나리오/자산/취약성/위협/통제 검색..." />
          <button id="btnCollapseAll" class="btn btn-sm">접기</button>
          <button id="btnExpandAll" class="btn btn-sm">펼치기</button>
        </div>
      </div>

      <div id="surveyMount"></div>
    </section>

    <!-- Results Page -->
    <section id="page-results" class="page">
      <div class="card results-head">
        <div class="survey-head-top" style="padding:0;border:0;background:transparent;box-shadow:none;">
          <div>
            <h3 style="margin:0;font-size:20px">결과</h3>
            <p style="margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.55">
              최종 Risk를 표시합니다. <b>RED</b> 시나리오에는 Risk(after) &lt; DoA(4)가 되는 통제를 <b>Final KPI</b> 내림차순으로 추천합니다.
            </p>
          </div>
          <div class="survey-actions" style="margin-left:auto">
            <button id="btnBackToSurvey" class="btn btn-sm">체크리스트로</button>
            <button id="btnBackToStart" class="btn btn-ghost btn-sm">Start로</button>
          </div>
        </div>
        <div class="meta" style="margin-top:12px">
          <span class="tag">GREEN: <b id="greenCount">0</b></span>
          <span class="tag">RED: <b id="redCount">0</b></span>
          <span class="tag">추천 기준: <b>After Risk &lt; 4</b> + <b>Final KPI</b></span>
        </div>
      </div>

      <div id="resultsMount"></div>
    </section>
  </div>

  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h3 id="overlayTitle">로딩 중…</h3>
      <p id="overlayMsg">stms_db.xlsx를 읽고 있습니다.</p>
      <div class="row">
        <button id="overlayClose" class="btn btn-sm">닫기</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const DOA = 4;

  // Excel column names (원본 엑셀 기준)
  const COL_CANDIDATES = {
    scenario: ["Risk 시나리오", "Risk scenario", "Scenario"],
    asset: ["Asset"],
    vuln: ["Vuln"],
    threat: ["Threat"],
    control: ["Control"],
    before: ["Risk Value\n(Before Control)", "Risk Value (Before Control)", "Risk Value Before Control"],
    after: ["Risk Value\n(After Control)", "Risk Value (After Control)", "Risk Value After Control"],
    finalKpi: ["Final KPI \n= Scaled KPI1 \n+ Scaled KPI2", "Final KPI", "Final KPI (Scaled KPI1 + Scaled KPI2)"],
    quickwins: ["Quick Wins \n여부", "Quick Wins 여부", "Quick Wins"]
  };

  const GROUPS = [
    { key: "tangible", title: "Section 1: Tangible asset group", desc: "유형자산(핸드폰/돈/여권/소지품) 관련 시나리오" },
    { key: "health", title: "Section 2: Health & Safety asset group", desc: "건강/치안/위생/편의 관련 시나리오" },
    { key: "psy", title: "Section 3: Psychological asset group", desc: "심리자산(미적 만족감/재미/관계/시간) 관련 시나리오" },
  ];

  const ASSET_GROUP = new Map([
    ["핸드폰", "tangible"],
    ["여권", "tangible"],
    ["돈(현금/카드)", "tangible"],
    ["소지품(가방, 지갑, 카메라 등)", "tangible"],

    ["건강", "health"],
    ["치안", "health"],
    ["위생", "health"],
    ["편의", "health"],

    ["미적 만족감", "psy"],
    ["재미", "psy"],
    ["동행자와의 관계", "psy"],
    ["소모시간", "psy"],
  ]);

  const state = {
    db: null,              // parsed data
    answers: {},           // controlId -> boolean (true=Yes, false=No)
    collapsedAll: false,
    search: "",
  };

  // DOM
  const $ = (q) => document.querySelector(q);
  const $$ = (q) => Array.from(document.querySelectorAll(q));

  const els = {
    steps: $$(".step"),
    pageStart: $("#page-start"),
    pageSurvey: $("#page-survey"),
    pageResults: $("#page-results"),

    yesCount: $("#yesCount"),
    totalControls: $("#totalControls"),

    btnStart: $("#btnStart"),
    btnReload: $("#btnReload"),
    btnReset: $("#btnReset"),
    btnToResults: $("#btnToResults"),
    btnBackToSurvey: $("#btnBackToSurvey"),
    btnBackToStart: $("#btnBackToStart"),

    searchBox: $("#searchBox"),
    btnCollapseAll: $("#btnCollapseAll"),
    btnExpandAll: $("#btnExpandAll"),

    surveyMount: $("#surveyMount"),
    resultsMount: $("#resultsMount"),

    greenCount: $("#greenCount"),
    redCount: $("#redCount"),

    overlay: $("#overlay"),
    overlayTitle: $("#overlayTitle"),
    overlayMsg: $("#overlayMsg"),
    overlayClose: $("#overlayClose"),
  };

  // Utilities
  function normKey(s){
    return String(s ?? "")
      .replace(/\s+/g, " ")
      .replace(/\r?\n/g, " ")
      .trim()
      .toLowerCase();
  }
  function pickColumnKey(keys, candidates){
    const keySet = new Map(keys.map(k => [normKey(k), k]));
    for (const cand of candidates){
      const exact = keySet.get(normKey(cand));
      if (exact) return exact;
    }
    // contains fallback
    for (const cand of candidates){
      const n = normKey(cand);
      for (const k of keys){
        if (normKey(k).includes(n)) return k;
      }
    }
    return null;
  }
  function toNumber(v){
    if (v === null || v === undefined) return NaN;
    if (typeof v === "number") return v;
    const s = String(v).trim();
    if (!s || s.startsWith("#")) return NaN;
    const cleaned = s.replace(/,/g, "");
    const num = parseFloat(cleaned);
    return Number.isFinite(num) ? num : NaN;
  }
  function fmtRisk(v){
    if (!Number.isFinite(v)) return "—";
    // 엑셀 값이 0.1/8.1/16.2처럼 소수 1자리인 경우가 많아서 1자리 고정
    return (Math.round(v * 10) / 10).toFixed(1);
  }
  function showOverlay(title, msg){
    els.overlayTitle.textContent = title || "처리 중…";
    els.overlayMsg.textContent = msg || "";
    els.overlay.classList.add("show");
    els.overlay.setAttribute("aria-hidden", "false");
  }
  function hideOverlay(){
    els.overlay.classList.remove("show");
    els.overlay.setAttribute("aria-hidden", "true");
  }
  function setActiveStep(name){
    els.steps.forEach(s => s.classList.toggle("active", s.dataset.nav === name));
  }
  function goPage(name){
    els.pageStart.classList.toggle("active", name === "start");
    els.pageSurvey.classList.toggle("active", name === "survey");
    els.pageResults.classList.toggle("active", name === "results");
    setActiveStep(name);
    history.replaceState(null, "", "#" + name);
  }

  // Risk logic:
  // 최종 Risk = before 와 (Yes로 선택된 control들의 afterRisk) 중 최솟값
  function calcFinalRisk(scenario){
    let r = scenario.beforeRisk;
    for (const c of scenario.controls){
      if (state.answers[c.id] === true && Number.isFinite(c.afterRisk)){
        r = Math.min(r, c.afterRisk);
      }
    }
    return r;
  }

  function getYesCount(){
    return Object.values(state.answers).filter(v => v === true).length;
  }
  function updateTopStats(){
    const total = state.db ? state.db.totalControls : 0;
    els.totalControls.textContent = total;
    els.yesCount.textContent = String(getYesCount());
  }

  function scenarioMatchesQuery(s, q){
    if (!q) return true;
    const hay = [
      s.name, s.asset, s.vuln, s.threat,
      ...s.controls.map(c => c.text)
    ].join(" ").toLowerCase();
    return hay.includes(q.toLowerCase());
  }

  function buildScenarioCard(s){
    const finalRisk = calcFinalRisk(s);
    const isGreen = finalRisk < DOA;

    const card = document.createElement("div");
    card.className = "scenario";
    card.dataset.scenario = s.name;

    const head = document.createElement("div");
    head.className = "scenario-head";

    const title = document.createElement("div");
    title.className = "scenario-title";

    const name = document.createElement("div");
    name.className = "scenario-name";
    name.textContent = s.name;

    const assetBadge = document.createElement("span");
    assetBadge.className = "badge";
    assetBadge.innerHTML = `<strong>${escapeHtml(s.asset || "—")}</strong>`;

    const beforeBadge = document.createElement("span");
    beforeBadge.className = "badge blue";
    beforeBadge.innerHTML = `Before <strong>${fmtRisk(s.beforeRisk)}</strong>`;

    title.appendChild(name);
    title.appendChild(assetBadge);
    title.appendChild(beforeBadge);

    const status = document.createElement("div");
    status.className = "status";

    const statusPill = document.createElement("span");
    statusPill.className = "pill-status " + (isGreen ? "green" : "red");
    statusPill.textContent = isGreen ? "GREEN" : "RED";

    const collapseRow = document.createElement("div");
    collapseRow.className = "collapse-row";

    const toggleBtn = document.createElement("span");
    toggleBtn.className = "linklike";
    toggleBtn.textContent = "접기";
    toggleBtn.addEventListener("click", () => {
      body.classList.toggle("hidden");
      toggleBtn.textContent = body.classList.contains("hidden") ? "펼치기" : "접기";
    });

    collapseRow.appendChild(toggleBtn);
    status.appendChild(statusPill);
    status.appendChild(collapseRow);

    head.appendChild(title);
    head.appendChild(status);

    const sub = document.createElement("div");
    sub.className = "scenario-sub";
    sub.innerHTML = `
      <span>Vuln: <b>${escapeHtml(s.vuln || "—")}</b></span>
      <span>·</span>
      <span>Threat: <b>${escapeHtml(s.threat || "—")}</b></span>
      <span>·</span>
      <span>현재 최종 Risk: <b>${fmtRisk(finalRisk)}</b></span>
    `;

    const body = document.createElement("div");
    body.className = "scenario-body";


    // ✅ 시나리오별 "추천" 컨트롤 1개 선정 (After Risk < DOA 중 Final KPI 최대)
    const bestReco = s.controls
    .filter(c => Number.isFinite(c.afterRisk) && c.afterRisk < DOA)
    .reduce((best, c) => {
        const k = Number.isFinite(c.finalKpi) ? c.finalKpi : -Infinity;
        if (!best) return { id: c.id, kpi: k };
        if (k > best.kpi) return { id: c.id, kpi: k };
        return best;
    }, null);

    const bestRecoId = bestReco ? bestReco.id : null;



    for (const c of s.controls){
      const row = document.createElement("div");
      row.className = "control";

      const left = document.createElement("div");
      left.style.flex = "1";

      const txt = document.createElement("div");
      txt.className = "control-text";
      txt.textContent = c.text;

      const meta = document.createElement("div");
      meta.className = "control-meta";

      const yesRisk = Number.isFinite(c.afterRisk) ? fmtRisk(c.afterRisk) : "—";
      const noRisk = Number.isFinite(s.beforeRisk) ? fmtRisk(s.beforeRisk) : "—";

      const hint = document.createElement("span");
      hint.className = "hint";
      hint.textContent = `Yes → Risk = ${yesRisk}  |  No → Risk = ${noRisk}`;

      meta.appendChild(hint);

      // 추천 뱃지: 이 control 자체의 After Risk가 DoA 미만이면 추천 후보
        // ✅ 추천 뱃지: 시나리오별 1개만
        if (bestRecoId && c.id === bestRecoId) {
        const reco = document.createElement("span");
        reco.className = "hint reco";
        reco.textContent = "추천";
        meta.appendChild(reco);
        }


      // Quick Wins 여부 (있으면 표시)
      if (c.quickWins === true){
        const qw = document.createElement("span");
        qw.className = "hint";
        qw.style.borderStyle = "solid";
        qw.style.borderColor = "rgba(59,130,246,.35)";
        qw.style.background = "rgba(59,130,246,.10)";
        qw.style.color = "rgba(231,238,252,.92)";
        qw.style.fontWeight = "850";
        qw.textContent = "Quick Win";
        meta.appendChild(qw);
      }

      left.appendChild(txt);
      left.appendChild(meta);

      // Yes/No segment
      const seg = document.createElement("div");
      seg.className = "seg";

      const btnYes = document.createElement("button");
      btnYes.textContent = "Yes";
      const btnNo = document.createElement("button");
      btnNo.textContent = "No";

      function syncSeg(){
        const v = state.answers[c.id];
        btnYes.classList.toggle("active-yes", v === true);
        btnNo.classList.toggle("active-no", v === false);
      }

      btnYes.addEventListener("click", () => {
        state.answers[c.id] = true;
        syncSeg();
        refreshScenarioCard(card, s);
        updateTopStats();
      });

      btnNo.addEventListener("click", () => {
        state.answers[c.id] = false;
        syncSeg();
        refreshScenarioCard(card, s);
        updateTopStats();
      });

      seg.appendChild(btnYes);
      seg.appendChild(btnNo);

      // default는 No(체크리스트 성격)
      syncSeg();

      row.appendChild(left);
      row.appendChild(seg);

      body.appendChild(row);
    }

    card.appendChild(head);
    card.appendChild(sub);
    card.appendChild(body);

    // search 필터를 위한 data attribute
    card.dataset.searchable = [
      s.name, s.asset, s.vuln, s.threat,
      ...s.controls.map(c => c.text)
    ].join(" ").toLowerCase();

    return card;
  }

  function refreshScenarioCard(card, scenario){
    // status + final risk만 갱신
    const finalRisk = calcFinalRisk(scenario);
    const isGreen = finalRisk < DOA;

    const pill = card.querySelector(".pill-status");
    pill.classList.toggle("green", isGreen);
    pill.classList.toggle("red", !isGreen);
    pill.textContent = isGreen ? "GREEN" : "RED";

    const sub = card.querySelector(".scenario-sub");
    if (sub){
      sub.innerHTML = `
        <span>Vuln: <b>${escapeHtml(scenario.vuln || "—")}</b></span>
        <span>·</span>
        <span>Threat: <b>${escapeHtml(scenario.threat || "—")}</b></span>
        <span>·</span>
        <span>현재 최종 Risk: <b>${fmtRisk(finalRisk)}</b></span>
      `;
    }
  }

  function buildSection(group){
    const wrap = document.createElement("div");
    wrap.className = "section";

    const title = document.createElement("div");
    title.className = "section-title";
    title.innerHTML = `<h4>${escapeHtml(group.title)}</h4><span class="kdesc">${escapeHtml(group.desc)}</span>`;
    wrap.appendChild(title);

    const list = document.createElement("div");
    list.className = "section-list";
    wrap.appendChild(list);
    return {wrap, list};
  }

  function renderSurvey(){
    els.surveyMount.innerHTML = "";

    const groupToSection = new Map();
    for (const g of GROUPS){
      const s = buildSection(g);
      groupToSection.set(g.key, s);
      els.surveyMount.appendChild(s.wrap);
    }

    // scenario card 생성
    for (const s of state.db.scenarios){
      if (!scenarioMatchesQuery(s, state.search)) continue;
      const section = groupToSection.get(s.groupKey) || groupToSection.get("tangible");
      section.list.appendChild(buildScenarioCard(s));
    }

    updateTopStats();
  }

  function renderResults(){
    els.resultsMount.innerHTML = "";

    let green = 0, red = 0;

    const groupToMount = new Map();
    for (const g of GROUPS){
      const s = buildSection(g);
      // results는 조금 더 조밀하게
      s.wrap.style.marginTop = "14px";
      groupToMount.set(g.key, s);
      els.resultsMount.appendChild(s.wrap);
    }

    for (const sc of state.db.scenarios){
      const finalRisk = calcFinalRisk(sc);
      const isGreen = finalRisk < DOA;
      if (isGreen) green++; else red++;

      const item = document.createElement("div");
      item.className = "result-item";

      const top = document.createElement("div");
      top.className = "result-top";

      const name = document.createElement("div");
      name.className = "result-name";
      name.textContent = sc.name;

      const asset = document.createElement("span");
      asset.className = "badge";
      asset.innerHTML = `<strong>${escapeHtml(sc.asset || "—")}</strong>`;

      const before = document.createElement("span");
      before.className = "badge blue";
      before.innerHTML = `Before <strong>${fmtRisk(sc.beforeRisk)}</strong>`;

      const final = document.createElement("span");
      final.className = "badge blue";
      final.innerHTML = `Final <strong>${fmtRisk(finalRisk)}</strong>`;

      const status = document.createElement("span");
      status.className = "pill-status " + (isGreen ? "green" : "red");
      status.textContent = isGreen ? "GREEN" : "RED";

      top.appendChild(name);
      top.appendChild(asset);
      top.appendChild(before);
      top.appendChild(final);
      top.appendChild(status);

      const sub = document.createElement("div");
      sub.className = "result-sub";
      sub.innerHTML = `Vuln: <b>${escapeHtml(sc.vuln || "—")}</b> · Threat: <b>${escapeHtml(sc.threat || "—")}</b>`;

      item.appendChild(top);
      item.appendChild(sub);

      // RED인 경우 추천 통제
      if (!isGreen){
        const candidates = sc.controls
          .filter(c => Number.isFinite(c.afterRisk) && c.afterRisk < DOA)
          .filter(c => state.answers[c.id] !== true); // 이미 Yes인 건 굳이 추천에서 제외
        candidates.sort((a,b) => (b.finalKpi ?? -Infinity) - (a.finalKpi ?? -Infinity));

        const box = document.createElement("div");
        box.className = "reco-list";

        if (candidates.length === 0){
          const none = document.createElement("div");
          none.className = "small";
          none.style.color = "var(--muted)";
          none.textContent = "추천 가능한 통제가 없습니다. (After Risk < 4 조건을 만족하는 통제가 없거나, 이미 Yes로 적용됨)";
          box.appendChild(none);
        } else {
          // 추천 항목 표시
          for (const c of candidates){
            const r = document.createElement("div");
            r.className = "reco-item";

            const txt = document.createElement("div");
            txt.className = "txt";
            txt.textContent = c.text + `\n→ After Risk: ${fmtRisk(c.afterRisk)}`;

            const kpi = document.createElement("div");
            kpi.className = "kpi";
            kpi.textContent = `Final KPI: ${fmtKpi(c.finalKpi)}`;

            r.appendChild(txt);
            r.appendChild(kpi);
            box.appendChild(r);
          }
        }

        item.appendChild(box);
      }

      const mount = groupToMount.get(sc.groupKey) || groupToMount.get("tangible");
      mount.list.appendChild(item);
    }

    els.greenCount.textContent = String(green);
    els.redCount.textContent = String(red);

    updateTopStats();
  }

  function fmtKpi(v){
    if (!Number.isFinite(v)) return "—";
    // KPI는 소수 3자리까지만
    const x = Math.round(v * 1000) / 1000;
    return String(x);
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function loadExcelDB(){
    showOverlay("로딩 중…", "stms_db.xlsx를 읽고 있습니다.");
    try{
      const res = await fetch("stms_db.xlsx", { cache: "no-store" });
      if (!res.ok) throw new Error("엑셀 파일을 불러오지 못했습니다. (HTTP " + res.status + ")");
      const buf = await res.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      const sheetName = wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];

      const rows = XLSX.utils.sheet_to_json(sheet, { defval: null, raw: true });

      if (!rows || rows.length === 0) throw new Error("엑셀 시트가 비어 있습니다.");

      // column keys resolve
      const keys = Object.keys(rows[0]);
      const kScenario = pickColumnKey(keys, COL_CANDIDATES.scenario);
      const kAsset = pickColumnKey(keys, COL_CANDIDATES.asset);
      const kVuln = pickColumnKey(keys, COL_CANDIDATES.vuln);
      const kThreat = pickColumnKey(keys, COL_CANDIDATES.threat);
      const kControl = pickColumnKey(keys, COL_CANDIDATES.control);
      const kBefore = pickColumnKey(keys, COL_CANDIDATES.before);
      const kAfter = pickColumnKey(keys, COL_CANDIDATES.after);
      const kFinal = pickColumnKey(keys, COL_CANDIDATES.finalKpi);
      const kQw = pickColumnKey(keys, COL_CANDIDATES.quickwins);

      const missing = [];
      if (!kScenario) missing.push("Risk 시나리오");
      if (!kControl) missing.push("Control");
      if (!kBefore) missing.push("Risk Value (Before Control)");
      if (!kAfter) missing.push("Risk Value (After Control)");
      if (!kAsset) missing.push("Asset");
      if (!kVuln) missing.push("Vuln");
      if (!kThreat) missing.push("Threat");
      // final KPI는 없을 수도 있으니 optional 처리 (추천 정렬에만 필요)
      if (missing.length) {
        throw new Error("엑셀 컬럼을 찾을 수 없습니다: " + missing.join(", "));
      }

      // parse
      const byScenario = new Map();
      let controlSeq = 0;
      let totalControls = 0;

      for (const r of rows){
        const sNameRaw = r[kScenario];
        const cTextRaw = r[kControl];

        const sName = String(sNameRaw ?? "").trim();
        const cText = String(cTextRaw ?? "").trim();

        // 첫번째 열(Risk 시나리오)이 비어있으면 넘어감 (요구사항)
        if (!sName) continue;
        // Control이 비어있어도 무시
        if (!cText) continue;

        const asset = String(r[kAsset] ?? "").trim();
        const vuln = String(r[kVuln] ?? "").trim();
        const threat = String(r[kThreat] ?? "").trim();
        const beforeRisk = toNumber(r[kBefore]);
        const afterRisk = toNumber(r[kAfter]);
        const finalKpi = kFinal ? toNumber(r[kFinal]) : NaN;

        const qwRaw = kQw ? r[kQw] : null;
        const quickWins = (typeof qwRaw === "string")
          ? /y|yes|true|o|ㅇ|✓/i.test(qwRaw.trim())
          : (qwRaw === true || qwRaw === 1);

        if (!byScenario.has(sName)){
          const groupKey = ASSET_GROUP.get(asset) || "tangible";
          byScenario.set(sName, {
            name: sName,
            asset,
            vuln,
            threat,
            beforeRisk: Number.isFinite(beforeRisk) ? beforeRisk : NaN,
            groupKey,
            controls: []
          });
        }

        const sc = byScenario.get(sName);
        // beforeRisk가 NaN이고 이후 줄에 값이 있으면 채움
        if (!Number.isFinite(sc.beforeRisk) && Number.isFinite(beforeRisk)) sc.beforeRisk = beforeRisk;
        // asset/vuln/threat도 비어있으면 채움
        if (!sc.asset && asset) sc.asset = asset;
        if (!sc.vuln && vuln) sc.vuln = vuln;
        if (!sc.threat && threat) sc.threat = threat;

        const controlId = `c_${controlSeq++}`;
        sc.controls.push({
          id: controlId,
          text: cText,
          afterRisk,
          finalKpi: Number.isFinite(finalKpi) ? finalKpi : null,
          quickWins
        });

        totalControls++;
      }

      // scenarios array
      const scenarios = Array.from(byScenario.values());

      // group ordering + stable sort
      const groupOrder = new Map(GROUPS.map((g,i)=>[g.key,i]));
      scenarios.sort((a,b) => {
        const ga = groupOrder.get(a.groupKey) ?? 99;
        const gb = groupOrder.get(b.groupKey) ?? 99;
        if (ga !== gb) return ga - gb;
        // 종합적으로 asset -> name 순 정렬
        const aa = (a.asset || "").localeCompare(b.asset || "", "ko");
        if (aa !== 0) return aa;
        return (a.name || "").localeCompare(b.name || "", "ko");
      });

      // answers 초기화: 기본은 No(false)
      const answers = {};
      for (const sc of scenarios){
        for (const c of sc.controls){
          answers[c.id] = false;
        }
      }

      hideOverlay();

      return { scenarios, totalControls, answers };
    } catch (e){
      showOverlay("오류", e.message || String(e));
      throw e;
    }
  }

  async function ensureDBFresh(){
    const db = await loadExcelDB();
    state.db = db;
    state.answers = db.answers;
    state.search = "";
    els.searchBox.value = "";
    updateTopStats();
  }

  function applySearch(){
    const q = (els.searchBox.value || "").trim().toLowerCase();
    state.search = q;
    // 바로 리렌더(간단하게)
    renderSurvey();
  }

  // Events
  els.btnStart.addEventListener("click", async () => {
    if (!state.db){
      await ensureDBFresh().catch(()=>{});
      if (!state.db) return;
    }
    goPage("survey");
    renderSurvey();
  });

  els.btnReload.addEventListener("click", async () => {
    await ensureDBFresh().catch(()=>{});
    if (!state.db) return;
    // 현재 페이지 유지
    if (location.hash === "#survey"){
      renderSurvey();
    } else if (location.hash === "#results"){
      renderResults();
    }
    updateTopStats();
  });

  els.btnReset.addEventListener("click", () => {
    if (!state.db) return;
    for (const k of Object.keys(state.answers)){
      state.answers[k] = false;
    }
    renderSurvey();
    updateTopStats();
  });

  els.btnToResults.addEventListener("click", () => {
    if (!state.db) return;
    goPage("results");
    renderResults();
  });

  els.btnBackToSurvey.addEventListener("click", () => {
    goPage("survey");
    renderSurvey();
  });

  els.btnBackToStart.addEventListener("click", () => {
    goPage("start");
  });

  els.searchBox.addEventListener("input", () => applySearch());

  els.btnCollapseAll.addEventListener("click", () => {
    $$(".scenario .scenario-body").forEach(b => b.classList.add("hidden"));
    $$(".scenario .collapse-row .linklike").forEach(t => t.textContent = "펼치기");
  });

  els.btnExpandAll.addEventListener("click", () => {
    $$(".scenario .scenario-body").forEach(b => b.classList.remove("hidden"));
    $$(".scenario .collapse-row .linklike").forEach(t => t.textContent = "접기");
  });

  els.steps.forEach(s => {
    s.addEventListener("click", async () => {
      const nav = s.dataset.nav;
      if (nav === "start"){
        goPage("start");
        return;
      }
      if (!state.db){
        await ensureDBFresh().catch(()=>{});
        if (!state.db) return;
      }
      goPage(nav);
      if (nav === "survey") renderSurvey();
      if (nav === "results") renderResults();
    });
  });

  els.overlayClose.addEventListener("click", () => hideOverlay());

  // Init (hash routing)
  (async function init(){
    $("#doaTextTop").textContent = String(DOA);

    // 초기에는 start 페이지. 해시가 survey/results면 DB를 읽어서 이동
    const hash = (location.hash || "").replace("#", "");
    if (hash === "survey" || hash === "results"){
      await ensureDBFresh().catch(()=>{});
      if (!state.db){
        goPage("start");
        return;
      }
      goPage(hash);
      if (hash === "survey") renderSurvey();
      if (hash === "results") renderResults();
    } else {
      goPage("start");
    }
  })();

})();
</script>
</body>
</html>
